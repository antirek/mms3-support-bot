# Спецификация промпта для классификации намерений пользователя

## Обзор

Данная спецификация описывает структуру промпта для AI-модели, предназначенного для классификации намерений пользователя из произвольного текстового запроса и извлечения структурированных данных.

## Структура промпта

Промпт состоит из двух частей:
1. **Системный промпт** (system prompt) - инструкции для AI
2. **Пользовательский запрос** (user message) - запрос пользователя и (опционально) список намерений

### Расположение списка намерений

Список намерений может быть размещен в двух местах:

#### Вариант 1: Список намерений в системном промпте (рекомендуется для статичных наборов)

**Когда использовать:**
- Список намерений фиксирован и не меняется между запросами
- Один и тот же набор намерений используется для всех запросов
- Нужно уменьшить размер пользовательского запроса

**Преимущества:**
- Меньше токенов в каждом запросе (список передается один раз)
- Системный промпт содержит всю необходимую информацию
- Проще для реализации (не нужно передавать список каждый раз)

**Недостатки:**
- Сложнее изменить набор намерений (нужно менять системный промпт)
- Меньше гибкости для разных сценариев

#### Вариант 2: Список намерений в пользовательском запросе (рекомендуется для динамичных наборов)

**Когда использовать:**
- Список намерений может меняться между запросами
- Нужна гибкость для разных сценариев использования
- Разные наборы намерений для разных пользователей или контекстов

**Преимущества:**
- Гибкость: можно менять набор намерений без изменения системного промпта
- Поддержка разных сценариев с разными наборами намерений
- Легче тестировать с разными наборами намерений

**Недостатки:**
- Больше токенов в каждом запросе (список передается каждый раз)
- Нужно передавать список намерений в каждом запросе

**Рекомендация:** Используйте вариант 1 (в системном промпте) если список намерений статичен, вариант 2 (в пользовательском запросе) если нужна гибкость.

---

## 1. Системный промпт

### Базовая версия

```
Ты - ассистент для классификации намерений пользователя. Твоя задача - проанализировать запрос пользователя и определить его намерение из предоставленного списка намерений.

ПРАВИЛА КЛАССИФИКАЦИИ:
1. Сопоставь запрос пользователя с одним из доступных намерений
2. Если намерение определено, извлеки данные согласно структуре намерения
3. Проверь наличие всех обязательных полей (required: true)
4. Верни результат в формате JSON

ФОРМАТ ОТВЕТА:
Ответ должен быть валидным JSON объектом со следующей структурой:
{
  "status": "<статус>",
  "intent": "<идентификатор_намерения>",
  "data": { ... }
}

СТАТУСЫ:
- "success": намерение определено и все обязательные данные присутствуют
- "insufficient_data": намерение определено, но отсутствуют обязательные поля
- "unknown_intent": намерение не может быть определено (используй дефолтное намерение)

ПРАВИЛА:
- Используй только намерения из предоставленного списка
- Если намерение не найдено, используй дефолтное намерение (intent: "default_intent")
- Если намерение найдено, но не хватает обязательных полей, верни status: "insufficient_data" и укажи недостающие поля в data.missing_required_fields
- Типы данных определяй из описания полей
- Валидация формата данных на твое усмотрение
- Возвращай только валидный JSON, без дополнительных комментариев
```

### Базовая версия с включенным списком намерений

Если список намерений статичен, его можно включить в системный промпт:

```
Ты - ассистент для классификации намерений пользователя. Твоя задача - проанализировать запрос пользователя и определить его намерение из списка доступных намерений.

СПИСОК ДОСТУПНЫХ НАМЕРЕНИЙ:
[
  {
    "intent": "send_email",
    "description": "Пользователь хочет отправить электронное письмо",
    "examples": [...],
    "data": [...]
  },
  ...
]

ПРАВИЛА КЛАССИФИКАЦИИ:
1. Сопоставь запрос пользователя с одним из доступных намерений
2. Если намерение определено, извлеки данные согласно структуре намерения
3. Проверь наличие всех обязательных полей (required: true)
4. Верни результат в формате JSON

[остальные инструкции как в базовой версии]
```

**Примечание:** В этом случае список намерений не нужно передавать в пользовательском запросе.

### Расширенная версия (детальная)

```
Ты - ассистент для классификации намерений пользователя. Твоя задача - проанализировать запрос пользователя и определить его намерение из списка намерений.

**Примечание:** Список намерений может быть предоставлен в системном промпте (если статичен) или в пользовательском запросе (если динамичен).

## ЗАДАЧА

Проанализируй запрос пользователя и:
1. Определи намерение из предоставленного списка намерений
2. Извлеки данные согласно структуре определенного намерения
3. Валидируй наличие обязательных полей
4. Верни результат в формате JSON

## ФОРМАТ ОТВЕТА

Ответ должен быть валидным JSON объектом со следующей структурой:

{
  "status": "<статус>",
  "intent": "<идентификатор_намерения>",
  "data": { ... }
}

### Поле status

Статус результата классификации. Возможные значения:

- **"success"**: Намерение успешно определено и все обязательные данные присутствуют
  - `intent`: определенное намерение
  - `data`: объект с данными намерения (ключи соответствуют полям field из структуры намерения)

- **"insufficient_data"**: Намерение определено, но отсутствуют обязательные параметры
  - `intent`: определенное намерение
  - `data`: объект с полями:
    - `missing_required_fields` (массив строк): список недостающих обязательных полей
    - `comment` (строка, опционально): человекочитаемое сообщение о том, что требуется

- **"unknown_intent"**: Намерение не может быть определено из запроса
  - `intent`: "default_intent" (дефолтное намерение)
  - `data`: пустой объект {} или может содержать `comment` с объяснением

## ЛОГИКА ПРИНЯТИЯ РЕШЕНИЯ

Выполняй следующие шаги последовательно:

1. **Классификация намерения:**
   - Сопоставь запрос пользователя с описаниями намерений из списка
   - Используй примеры (examples) для лучшего понимания
   - Если намерение не найдено → верни status: "unknown_intent", intent: "default_intent"

2. **Извлечение данных:**
   - Если намерение найдено, извлеки данные согласно структуре data намерения
   - Используй описания полей (description) для определения значений
   - Используй примеры (examples) полей для понимания формата

3. **Валидация:**
   - Проверь наличие всех полей с required: true
   - Если все обязательные поля присутствуют → верни status: "success"
   - Если обязательные поля отсутствуют → верни status: "insufficient_data"

## ПРАВИЛА

- Используй ТОЛЬКО намерения из предоставленного списка
- Не придумывай новые намерения
- Типы данных определяй из описания полей (description)
- Валидация формата данных (email, дата, телефон и т.д.) на твое усмотрение
- Если запрос содержит контекст предыдущих реплик, учитывай его при классификации
- Возвращай только валидный JSON, без дополнительных комментариев или пояснений
- Если значение поля не указано явно, но может быть выведено из контекста - используй его
- Если значение поля не может быть определено - не включай его в результат (для необязательных полей)

## ПРИМЕРЫ

### Пример 1: Успешная классификация
Запрос: "Отправь письмо на адрес user@example.com с темой 'Встреча'"
Результат:
{
  "status": "success",
  "intent": "send_email",
  "data": {
    "recipient": "user@example.com",
    "subject": "Встреча"
  }
}

### Пример 2: Недостаточно данных
Запрос: "Отправь письмо"
Результат:
{
  "status": "insufficient_data",
  "intent": "send_email",
  "data": {
    "missing_required_fields": ["recipient", "subject"],
    "comment": "Для отправки письма необходимо указать получателя и тему"
  }
}

### Пример 3: Неопределенное намерение
Запрос: "Как дела?"
Результат:
{
  "status": "unknown_intent",
  "intent": "default_intent",
  "data": {
    "comment": "Не могу определить ваше намерение. Пожалуйста, уточните ваш вопрос"
  }
}
```

---

## 2. Формат входных данных

### Вариант 1: Список намерений в системном промпте

Если список намерений включен в системный промпт, пользовательский запрос содержит только:
1. Запрос пользователя (может быть дополнен контекстом)

**Пример системного промпта с намерениями:**
```
Ты - ассистент для классификации намерений пользователя.

Список доступных намерений:
[
  {
    "intent": "send_email",
    "description": "Пользователь хочет отправить электронное письмо",
    ...
  }
]

[остальные инструкции]
```

**Пример пользовательского запроса:**
```
Запрос пользователя: "Отправь письмо на адрес user@example.com с темой 'Встреча'"
```

### Вариант 2: Список намерений в пользовательском запросе

Если список намерений передается в пользовательском запросе, он должен содержать:
1. Запрос пользователя (может быть дополнен контекстом)
2. Список намерений в формате JSON

### Пример пользовательского запроса (вариант 2)

```
Запрос пользователя: "Отправь письмо на адрес user@example.com с темой 'Встреча'"

Список намерений:
[
  {
    "intent": "send_email",
    "description": "Пользователь хочет отправить электронное письмо",
    "examples": [
      "Отправь письмо на адрес user@example.com",
      "Напиши письмо с темой 'Встреча'",
      "Отправь email"
    ],
    "data": [
      {
        "field": "recipient",
        "description": "Email адрес получателя письма",
        "required": true,
        "examples": ["user@example.com", "admin@company.com"]
      },
      {
        "field": "subject",
        "description": "Тема письма",
        "required": true,
        "examples": ["Встреча", "Важное сообщение", "Отчет"]
      },
      {
        "field": "body",
        "description": "Текст письма",
        "required": false,
        "examples": ["Здравствуйте, хочу обсудить проект", "Привет, как дела?"]
      }
    ]
  },
  {
    "intent": "default_intent",
    "description": "Намерение не определено или не соответствует ни одному из доступных намерений",
    "data": []
  }
]
```

### Формат с контекстом

Если нужно передать контекст предыдущих реплик, включи его в запрос пользователя:

```
Контекст диалога:
- Пользователь: "Хочу отправить письмо"
- Ассистент: "Кому отправить?"
- Пользователь: "На адрес user@example.com"

Текущий запрос пользователя: "С темой 'Встреча'"

Список намерений:
[...]
```

---

## 3. Формат выходных данных

### Структура ответа

Все ответы имеют единую структуру:

```json
{
  "status": "<статус>",
  "intent": "<идентификатор_намерения>",
  "data": { ... }
}
```

**Общие поля в data:**
- Поля, определенные в структуре намерения (согласно `field` из списка намерений)
- `comment` (опциональное, строка): человекочитаемое сообщение для пользователя. Может использоваться в любом статусе для пояснения результата классификации или для ответа пользователю

### Статус: success

```json
{
  "status": "success",
  "intent": "send_email",
  "data": {
    "recipient": "user@example.com",
    "subject": "Встреча",
    "body": "Текст письма"
  }
}
```

**Правила:**
- Все обязательные поля должны присутствовать
- Необязательные поля могут отсутствовать
- Ключи в `data` соответствуют полям `field` из структуры намерения
- `comment` (опционально): человекочитаемое сообщение, например, суть вопроса клиента или пояснение

### Статус: insufficient_data

```json
{
  "status": "insufficient_data",
  "intent": "send_email",
  "data": {
    "missing_required_fields": ["recipient", "subject"],
    "comment": "Для отправки письма необходимо указать получателя и тему"
  }
}
```

**Правила:**
- `intent` содержит определенное намерение (не "default_intent")
- `missing_required_fields` - массив всех недостающих обязательных полей
- `comment` - опциональное поле с человекочитаемым сообщением о том, что требуется

### Статус: unknown_intent

```json
{
  "status": "unknown_intent",
  "intent": "default_intent",
  "data": {}
}
```

**Правила:**
- Используется только когда намерение не может быть определено
- `intent` всегда "default_intent"
- `data` - пустой объект или может содержать `comment` с объяснением
- `comment` (опционально): человекочитаемое сообщение, объясняющее почему намерение не определено или что требуется от пользователя

---

## 4. Примеры использования

### Пример 1: Полная классификация

**Вход:**
```
Запрос пользователя: "Создай задачу 'Подготовить отчет' с приоритетом высоким"

Список намерений:
[
  {
    "intent": "create_task",
    "description": "Пользователь хочет создать новую задачу",
    "examples": ["Создай задачу", "Добавь задачу", "Новая задача"],
    "data": [
      {
        "field": "title",
        "description": "Название задачи",
        "required": true,
        "examples": ["Подготовить отчет", "Позвонить клиенту"]
      },
      {
        "field": "priority",
        "description": "Приоритет задачи (низкий, средний, высокий)",
        "required": false,
        "examples": ["низкий", "средний", "высокий"]
      }
    ]
  }
]
```

**Выход:**
```json
{
  "status": "success",
  "intent": "create_task",
  "data": {
    "title": "Подготовить отчет",
    "priority": "высокий"
  }
}
```

### Пример 2: Недостаточно данных

**Вход:**
```
Запрос пользователя: "Создай задачу"

Список намерений: [тот же что в примере 1]
```

**Выход:**
```json
{
  "status": "insufficient_data",
  "intent": "create_task",
  "data": {
    "missing_required_fields": ["title"],
    "comment": "Для создания задачи необходимо указать название"
  }
}
```

### Пример 3: С контекстом

**Вход:**
```
Контекст диалога:
- Пользователь: "Хочу создать задачу"
- Ассистент: "Какое название у задачи?"
- Пользователь: "Подготовить отчет"

Текущий запрос пользователя: "С приоритетом высоким"

Список намерений: [тот же что в примере 1]
```

**Выход:**
```json
{
  "status": "success",
  "intent": "create_task",
  "data": {
    "title": "Подготовить отчет",
    "priority": "высокий"
  }
}
```

### Пример 4: Неопределенное намерение

**Вход:**
```
Запрос пользователя: "Расскажи анекдот"

Список намерений:
[
  {
    "intent": "send_email",
    "description": "Пользователь хочет отправить электронное письмо",
    "data": [...]
  },
  {
    "intent": "create_task",
    "description": "Пользователь хочет создать новую задачу",
    "data": [...]
  },
  {
    "intent": "default_intent",
    "description": "Намерение не определено",
    "data": []
  }
]
```

**Выход:**
```json
{
  "status": "unknown_intent",
  "intent": "default_intent",
  "data": {
    "comment": "Не могу определить ваше намерение. Пожалуйста, уточните ваш вопрос"
  }
}
```

---

## 5. Рекомендации по использованию

### Best practices

1. **Выбор варианта размещения списка намерений:**
   - Если список намерений статичен и не меняется → используй вариант 1 (в системном промпте)
   - Если нужна гибкость и разные наборы намерений → используй вариант 2 (в пользовательском запросе)
   - Для большинства случаев с фиксированным набором намерений рекомендуется вариант 1

2. **Формирование списка намерений:**
   - Используй четкие и однозначные описания намерений
   - Добавляй примеры запросов для лучшего распознавания
   - Указывай примеры значений для полей
   - Всегда включай дефолтное намерение в список

3. **Обработка контекста:**
   - Передавай контекст явно в запросе пользователя
   - Форматируй контекст для лучшего понимания AI
   - Учитывай, что AI может использовать контекст для заполнения недостающих полей

4. **Валидация ответа:**
   - Всегда проверяй валидность JSON ответа
   - Проверяй наличие обязательных полей в ответе
   - Валидируй соответствие структуры ответа ожидаемой

5. **Обработка ошибок:**
   - Обрабатывай все три статуса (success, insufficient_data, unknown_intent)
   - Для insufficient_data - запрашивай недостающие поля у пользователя
   - Для unknown_intent - уточняй намерение у пользователя

### Ограничения

1. AI определяет типы данных из описания, явные типы не указываются
2. Валидация формата (email, дата и т.д.) на усмотрение AI
3. Вложенные структуры данных не поддерживаются (плоская структура)
4. Одно описание на намерение (множественные описания не поддерживаются)

### Известные проблемы

1. AI может неправильно интерпретировать неоднозначные запросы
2. Контекст может быть не всегда учтен корректно
3. Валидация формата может быть не строгой

---

## 6. Шаблоны промптов

### Вариант 1: Список намерений в системном промпте

#### Минимальный шаблон

```
[СИСТЕМНЫЙ ПРОМПТ]
Ты - ассистент для классификации намерений пользователя.

Список доступных намерений:
{intents_json}

[остальные инструкции из системного промпта]

[ЗАПРОС ПОЛЬЗОВАТЕЛЯ]
Запрос пользователя: "{user_query}"
```

#### Расширенный шаблон с контекстом

```
[СИСТЕМНЫЙ ПРОМПТ]
Ты - ассистент для классификации намерений пользователя.

Список доступных намерений:
{intents_json}

[остальные инструкции из системного промпта]

[ЗАПРОС ПОЛЬЗОВАТЕЛЯ]
Контекст диалога:
{context_history}

Текущий запрос пользователя: "{user_query}"
```

### Вариант 2: Список намерений в пользовательском запросе

#### Минимальный шаблон

```
[СИСТЕМНЫЙ ПРОМПТ - базовая версия]

[ЗАПРОС ПОЛЬЗОВАТЕЛЯ]
Запрос пользователя: "{user_query}"

Список намерений:
{intents_json}
```

#### Расширенный шаблон с контекстом

```
[СИСТЕМНЫЙ ПРОМПТ - расширенная версия]

[ЗАПРОС ПОЛЬЗОВАТЕЛЯ]
Контекст диалога:
{context_history}

Текущий запрос пользователя: "{user_query}"

Список намерений:
{intents_json}
```

---

## 7. Тестирование

### Тестовые сценарии

1. **Успешная классификация:**
   - Запрос содержит все необходимые данные
   - Ожидаемый статус: "success"

2. **Недостаточно данных:**
   - Запрос определяет намерение, но не хватает обязательных полей
   - Ожидаемый статус: "insufficient_data"
   - Проверить наличие всех недостающих полей в missing_required_fields

3. **Неопределенное намерение:**
   - Запрос не соответствует ни одному намерению
   - Ожидаемый статус: "unknown_intent"
   - Ожидаемый intent: "default_intent"

4. **С контекстом:**
   - Запрос использует данные из предыдущих реплик
   - Проверить корректное извлечение данных из контекста

5. **Граничные случаи:**
   - Пустой запрос
   - Запрос с неполными данными
   - Запрос с избыточными данными

---

## Заключение

Данная спецификация описывает полный подход к классификации намерений пользователя с использованием AI. Следуя этой спецификации, можно создать надежную систему классификации намерений с машиночитаемым форматом результата.

